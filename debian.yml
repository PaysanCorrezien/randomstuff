---
- hosts: localhost
  become: yes
  vars_prompt:
    - name: "githubuser"
      prompt: "Enter your GitHub username"
      private: no
    - name: "githubtoken"
      prompt: "Enter your GitHub personal access token"
      private: yes
  tasks:
    - name: Install required packages
      shell: |
        apt-get update
        apt-get install -y curl git python3 python3-pip python3-setuptools xclip zathura wget autorandr jq flameshot fzf zoxide bat ripgrep tmux fd-find exa neofetch

    - name: Clone the dotfiles repository
      git:
        repo: "https://{{ githubtoken }}@github.com/paysancorrezien/dotfiles.git"
        dest: "~/dotfiles"
        version: main
        force: yes

    - name: Ensure remote URL does not contain credentials
      git_config:
        name: remote.origin.url
        value: "https://github.com/paysancorrezien/dotfiles.git"
        scope: local
        repo: "~/dotfiles"

    - name: Install python packages
      pip:
        name:
        - pip
        - chezmoi
        state: latest
        executable: pip3

    - name: Initialize chezmoi
      command: chezmoi init --apply {{ githubuser }}

    - name: Update chezmoi
      command: chezmoi update

    - name: Install NVM
      shell: |
        curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
      args:
        creates: "{{ ansible_env.HOME }}/.nvm/nvm.sh"

    - name: Install Node.js
      shell: |
        . "{{ ansible_env.HOME }}/.nvm/nvm.sh"
        nvm install node
      args:
        creates: "{{ ansible_env.HOME }}/.nvm/versions/node"

    - name: Install Zap for Zsh
      shell: |
        bash <(curl -s https://raw.githubusercontent.com/zap-zsh/zap/master/bin/install)

    - name: Change shell to zsh
      user:
        name: "{{ ansible_env.USER }}"
        shell: /usr/bin/zsh

    - name: Allow ansible user to execute sudo without password
      lineinfile:
        dest: /etc/sudoers
        line: '{{ ansible_user }} ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
